# Connapse v0.2.0 — Security & Auth Implementation Plan

## Context

Connapse v0.1.0 has **zero authentication or authorization**. All 7 API endpoint groups, the MCP server, and the SignalR hub are publicly accessible. This is the #1 priority for v0.2.0 per the roadmap and [issue #7](https://github.com/Destrayon/Connapse/issues/7).

**Goal**: Add a three-tier auth system (Cookie + PAT + JWT), RBAC with 4 roles, rate limiting, and audit logging — making Connapse safe for non-localhost deployment.

**User decisions**:
- All three auth tiers in v0.2.0 (not deferred)
- New `Connapse.Identity` project (separate from Storage)
- Admin setup via env vars (`CONNAPSE_ADMIN_EMAIL` + `CONNAPSE_ADMIN_PASSWORD`)
- Minimal UI: login/register, PAT management, basic user list
- JWT primary use case: 60-90 minute access tokens for future SDK clients

---

## Session Breakdown

This plan is a **reference document** implemented across multiple sessions. Each session produces a buildable/testable state.

| Session | Phases | Deliverable | State After |
|---------|--------|-------------|-------------|
| **A** | 1-2 | Identity project + EF migration | Compiles, Identity tables exist, admin seeded, no auth enforced yet |
| **B** | 3 | Cookie auth + Blazor wiring | Login page works, UI requires authentication |
| **C** | 4-5 | PAT + JWT systems | All three auth tiers functional, auth endpoints live |
| **D** | 6 | RBAC + endpoint protection | Access control enforced on all endpoints |
| **E** | 7-8 | Rate limiting, audit logging, UI pages | PAT management UI, user list, rate limits active |
| **F** | 9 | CLI updates | `connapse auth login` works, all CLI commands authenticated |
| **G** | 10-11 | Testing + deployment | Full test suite, docker-compose ready, docs updated |

---

## Auth Model Summary

| Tier | Mechanism | Used By | Lifetime |
|------|-----------|---------|----------|
| Cookie | ASP.NET Core Identity | Blazor UI | 14-day sliding |
| PAT | `X-Api-Key: cnp_...` SHA-256 hashed | CLI, MCP, REST API | Until revoked |
| JWT | HS256 short-lived bearer | SDK clients, external integrations | 60-90 min + refresh |

### JWT Signing: HS256 (with RS256 migration path in v0.3.0)

**Decision**: Use HS256 (symmetric HMAC) for v0.2.0. Migrate to RS256 when adding OpenIddict/OIDC in v0.3.0.

**Rationale**:
- Connapse is a single service — both issues and validates tokens. HS256 is correct for this topology.
- Comparable self-hosted apps (Supabase, Outline, Gitea internal tokens) all use HS256.
- Simpler for Docker users: `CONNAPSE_JWT_SECRET` env var vs RSA key file management.
- Migration to RS256 is low-cost (~2-4 hrs, isolated behind `ITokenService`). Outstanding 60-90 min tokens expire naturally on upgrade.

**Implementation**:
- Accept `CONNAPSE_JWT_SECRET` env var (minimum 64 characters)
- If not provided, auto-generate on first run, persist to data directory
- Log warning at startup if using auto-generated secret
- Wrap signing behind `ITokenService` interface for clean v0.3.0 swap to RS256

Routing via `AddPolicyScheme("MultiScheme")` with `ForwardDefaultSelector`:
- `X-Api-Key` header → ApiKey handler
- `Authorization: Bearer` header → JWT handler
- Default → Cookie handler

---

## Phase 1: Connapse.Identity Project Setup

**Complexity: L** | **Dependencies: None** | **Session: A**

### New project + solution wiring
- Create `src/Connapse.Identity/Connapse.Identity.csproj` with packages: `Microsoft.AspNetCore.Identity.EntityFrameworkCore`, `Microsoft.AspNetCore.Authentication.JwtBearer`, `Npgsql.EntityFrameworkCore.PostgreSQL`
- Add to `Connapse.slnx`
- Add project reference from `Connapse.Web` and `Connapse.CLI`

### Separate Identity DbContext
- `src/Connapse.Identity/Data/ConnapseIdentityDbContext.cs` — extends `IdentityDbContext<ConnapseUser, ConnapseRole, Guid>`
- Shares the same PostgreSQL database as `KnowledgeDbContext` but owns its own tables and migration history
- Remap all Identity tables to snake_case (`AspNetUsers` → `users`, `AspNetRoles` → `roles`, etc.)
- Follow existing conventions: UUID PKs via `gen_random_uuid()`, TIMESTAMPTZ timestamps, `HasColumnName()` for snake_case

### Entity definitions (all in `src/Connapse.Identity/Data/Entities/`)

| Entity | Key Fields |
|--------|-----------|
| `ConnapseUser` : `IdentityUser<Guid>` | DisplayName, CreatedAt, LastLoginAt, IsSystemAdmin |
| `ConnapseRole` : `IdentityRole<Guid>` | Description, CreatedAt |
| `PersonalAccessTokenEntity` | UserId, Name, TokenHash (SHA-256), TokenPrefix (first 12 chars), Scopes (comma-separated), CreatedAt, ExpiresAt, LastUsedAt, RevokedAt |
| `RefreshTokenEntity` | UserId, TokenHash, ExpiresAt, RevokedAt, ReplacedByTokenHash (rotation) |
| `AuditLogEntity` | UserId?, Action, ResourceType?, ResourceId?, Details (JSONB), IpAddress, CreatedAt |

### Core interfaces and DTOs
- `src/Connapse.Core/Interfaces/IAuditLogger.cs` — `LogAsync(action, resourceType?, resourceId?, details?)`
- `src/Connapse.Core/Models/AuthModels.cs` — records: `LoginRequest`, `RegisterRequest`, `TokenResponse`, `PatCreateRequest`, `PatCreateResponse`, `PatListItem`, `UserListItem`

### Authentication handlers (all in `src/Connapse.Identity/Authentication/`)
- `ApiKeyAuthenticationHandler.cs` — reads `X-Api-Key`, SHA-256 hashes, DB lookup, creates ClaimsPrincipal with user + scope claims, fire-and-forget `last_used_at` update
- `ApiKeyAuthenticationOptions.cs` — constants: scheme name `"ApiKey"`, header `"X-Api-Key"`, prefix `"cnp_"`

### Authorization (all in `src/Connapse.Identity/Authorization/`)
- `ScopeRequirement.cs` — `IAuthorizationRequirement` with `Scope` property
- `ScopeAuthorizationHandler.cs` — checks scope claims; for cookie users, derives scopes from role (Admin→all, Editor→read+write, Viewer→read, Agent→read+ingest)

### Services (all in `src/Connapse.Identity/Services/`)
- `PatService.cs` — CRUD: generate `cnp_` + 32 random bytes base64url, store SHA-256 hash, list/revoke
- `JwtTokenService.cs` — HS256 signing with `CONNAPSE_JWT_SECRET` env var or auto-generated secret. Implements `ITokenService` interface for future RS256 swap. Access token generation (60-90 min configurable), refresh token generation+rotation.
- `JwtSettings.cs` — `Secret` (or auto-generated), `AccessTokenLifetimeMinutes` (default 60), `RefreshTokenLifetimeDays` (default 7), `Issuer`, `Audience`
- `AdminSeedService.cs` — reads env vars, creates admin user + Admin role on first startup if no users exist
- `AuditLogger.cs` — implements `IAuditLogger`, uses `IHttpContextAccessor` for user/IP

### DI extension
- `src/Connapse.Identity/IdentityServiceExtensions.cs` with three methods:
  - `AddConnapseIdentity()` — registers DbContext, Identity services, PatService, JwtTokenService, AdminSeedService, AuditLogger
  - `AddConnapseAuthentication()` — configures multi-scheme: Cookie + ApiKey + JWT + PolicyScheme router
  - `AddConnapseAuthorization()` — role policies + scope policies

---

## Phase 2: EF Core Integration

**Complexity: M** | **Dependencies: Phase 1** | **Session: A**

### Modify `src/Connapse.Web/Program.cs`
- Add `builder.Services.AddConnapseIdentity(builder.Configuration)`
- Add `builder.Services.AddConnapseAuthentication(builder.Configuration)`
- Add `builder.Services.AddConnapseAuthorization()`
- In startup scope block: migrate `ConnapseIdentityDbContext`, run `AdminSeedService.SeedAsync()`, seed 4 roles (Admin, Editor, Viewer, Agent)

### Generate migration
```bash
dotnet ef migrations add InitialIdentity \
  --project src/Connapse.Identity \
  --startup-project src/Connapse.Web \
  --context ConnapseIdentityDbContext
```

Use separate `__EFMigrationsHistory_Identity` table to avoid collision with Knowledge migrations.

---

## Phase 3: Cookie Auth for Blazor UI

**Complexity: M** | **Dependencies: Phase 2** | **Session: B**

### Middleware pipeline reorder in `Program.cs`

```
1. ExceptionHandler + HSTS (existing)
2. StatusCodePages (existing)
3. HttpsRedirection (existing)
4. CORS (existing)
5. UseAuthentication()          <-- NEW
6. UseAuthorization()           <-- NEW
7. UseAntiforgery() (existing, moved after auth)
8. Static assets (existing)
9. Razor components (existing)
10. API endpoints (existing)
11. SignalR hub (existing)
```

### Blazor auth wiring
- Modify `src/Connapse.Web/Components/App.razor` — wrap with `<CascadingAuthenticationState>`
- Modify `src/Connapse.Web/Components/Routes.razor` — replace `<RouteView>` with `<AuthorizeRouteView>`
- Modify `src/Connapse.Web/Components/_Imports.razor` — add `@using Microsoft.AspNetCore.Authorization` and `@using Microsoft.AspNetCore.Components.Authorization`
- Add `builder.Services.AddCascadingAuthenticationState()` to Program.cs

### Cookie configuration
- Login path: `/login`, Logout: `/logout`, Access denied: `/access-denied`
- 14-day sliding expiration, HttpOnly, SameSite=Strict, SecurePolicy=Always

**Critical**: Login/register pages MUST use static SSR (form POST), NOT InteractiveServer. Blazor InteractiveServer uses SignalR which needs auth — chicken-and-egg problem.

---

## Phase 4: PAT System

**Complexity: L** | **Dependencies: Phase 2** | **Session: C**

### Auth endpoints — `src/Connapse.Web/Endpoints/AuthEndpoints.cs`

All under `/api/v1/auth`:

| Method | Route | Auth | Purpose |
|--------|-------|------|---------|
| POST | `/login` | Anonymous | Cookie login for API clients |
| POST | `/register` | Anonymous (configurable) | Register new user (default role: Viewer) |
| POST | `/logout` | Authenticated | Clear cookie |
| POST | `/token` | Anonymous | Email+password → JWT TokenResponse |
| POST | `/token/refresh` | Anonymous | Refresh token → new TokenResponse |
| GET | `/pats` | Authenticated | List user's PATs |
| POST | `/pats` | Authenticated | Create PAT (returns token once) |
| DELETE | `/pats/{id}` | Authenticated | Revoke PAT |
| GET | `/users` | Admin only | List all users |
| PUT | `/users/{id}/roles` | Admin only | Assign roles |

Register in Program.cs: `app.MapAuthEndpoints()`

### PAT token format
- Generate: `cnp_` + 32 random bytes as base64url (44 chars total)
- Store: SHA-256 hash in DB, prefix (first 12 chars) for display
- Index `token_hash` column for fast lookups

### CLI integration — modify `src/Connapse.CLI/Program.cs`
- New commands: `auth login`, `auth logout`, `auth whoami`, `auth pat create/list/revoke`
- Credential storage: `~/.connapse/credentials.json` with `{ apiKey, apiBaseUrl, userEmail }`
- All existing commands auto-inject `X-Api-Key` header from stored credentials

---

## Phase 5: JWT Bearer

**Complexity: M** | **Dependencies: Phase 2** | **Session: C**

### Token endpoints (part of AuthEndpoints from Phase 4)
- `POST /api/v1/auth/token` — email+password → `{ accessToken, refreshToken, expiresAt }`
- `POST /api/v1/auth/token/refresh` — refresh token rotation (old revoked, new issued)

### HS256 key management
- Read `CONNAPSE_JWT_SECRET` env var (or `Identity:Jwt:Secret` in config)
- If not provided → auto-generate 64-byte random secret on first run, persist to data directory as `jwt-secret.key`
- Validate minimum 64 characters at startup
- Log warning if using auto-generated secret
- Wrap behind `ITokenService` interface for v0.3.0 RS256 migration

### SignalR query-string JWT
- Modify `src/Connapse.Web/Hubs/IngestionHub.cs` — add `[Authorize]`
- Configure JWT bearer `OnMessageReceived` event to read `access_token` from query string for `/hubs/*` paths

---

## Phase 6: RBAC + Endpoint Protection

**Complexity: L** | **Dependencies: Phases 3, 4, 5** | **Session: D**

### Roles and implicit scopes

| Role | Implicit Scopes |
|------|----------------|
| Admin | ALL scopes |
| Editor | `knowledge:read`, `knowledge:write` |
| Viewer | `knowledge:read` |
| Agent | `knowledge:read`, `agent:ingest` |

### Authorization policies
- `RequireAdmin` — role: Admin
- `RequireEditor` — roles: Admin, Editor
- `RequireViewer` — roles: Admin, Editor, Viewer
- `RequireAgent` — roles: Admin, Agent
- `Scope:KnowledgeRead`, `Scope:KnowledgeWrite`, `Scope:AdminUsers`, `Scope:AgentIngest`

### Endpoint protection — add `.RequireAuthorization()` to all endpoint groups

| Endpoint File | Read Ops | Write Ops | Admin Ops |
|--------------|----------|-----------|-----------|
| `ContainersEndpoints.cs` | RequireViewer | RequireEditor | — |
| `DocumentsEndpoints.cs` | RequireViewer | RequireEditor | — |
| `FoldersEndpoints.cs` | RequireViewer | RequireEditor | — |
| `SearchEndpoints.cs` | RequireViewer | — | — |
| `BatchesEndpoints.cs` | RequireViewer | RequireEditor | — |
| `SettingsEndpoints.cs` | RequireAdmin | RequireAdmin | RequireAdmin |
| `McpEndpoints.cs` | RequireAgent | RequireAgent | — |

### Blazor page authorization

| Page | Attribute |
|------|-----------|
| Home, FileBrowser, Search | `@attribute [Authorize]` |
| Settings | `@attribute [Authorize(Policy = "RequireAdmin")]` |
| Login, Register, AccessDenied | `@attribute [AllowAnonymous]` |

---

## Phase 7: Rate Limiting + Audit Logging

**Complexity: M** | **Dependencies: Phase 2** | **Session: E**

### Rate limiting — modify `src/Connapse.Web/Program.cs`
- Add `builder.Services.AddRateLimiter(...)` with per-user fixed window policies:
  - `"uploads"` — 100/hour
  - `"searches"` — 1000/hour
- `app.UseRateLimiter()` after `UseAuthorization()`
- Apply: `DocumentsEndpoints` upload → `RequireRateLimiting("uploads")`, `SearchEndpoints` → `RequireRateLimiting("searches")`

### Audit logging
- `AuditLogger` (from Phase 1) injected into endpoints for key events:
  - Auth: login, logout, register, PAT create/revoke
  - Knowledge: document upload/delete, container create/delete
  - Admin: role changes, settings changes

---

## Phase 8: UI Pages

**Complexity: M** | **Dependencies: Phases 3, 4, 6** | **Session: E**

### New Blazor pages (all in `src/Connapse.Web/Components/Pages/`)

| Page | Route | Mode | Purpose |
|------|-------|------|---------|
| `Login.razor` | `/login` | Static SSR | Email+password form POST |
| `Register.razor` | `/register` | Static SSR | Registration form (configurable: can be disabled) |
| `Logout.razor` | `/logout` | Static SSR | SignOut + redirect |
| `PersonalTokens.razor` | `/settings/tokens` | InteractiveServer | PAT CRUD table, show token once on creation |
| `Users.razor` | `/admin/users` | InteractiveServer | Read-only user list (Admin only) |
| `AccessDenied.razor` | `/access-denied` | Static SSR | Permission denied message |

### NavMenu update — modify `src/Connapse.Web/Components/Layout/NavMenu.razor`
- Wrap nav items in `<AuthorizeView>`
- Add admin-only link to Users page
- Add "API Tokens" link
- Add logout button/link

---

## Phase 9: CLI Updates

**Complexity: S** | **Dependencies: Phase 4** | **Session: F**

Covered in Phase 4. New commands: `auth login/logout/whoami`, `auth pat create/list/revoke`. Auto-inject `X-Api-Key` header from `~/.connapse/credentials.json` for all existing commands.

---

## Phase 10: Testing

**Complexity: L** | **Dependencies: All phases** | **Session: G**

### New test project: `tests/Connapse.Identity.Tests/`

**Unit tests** (xUnit + FluentAssertions + NSubstitute):

| Test Class | Count | Coverage |
|-----------|-------|----------|
| `PatServiceTests` | 5-8 | Token format, hash storage, revocation, scope validation, expiry |
| `JwtTokenServiceTests` | 4-6 | Token generation, validation, expiry, refresh rotation |
| `ApiKeyAuthenticationHandlerTests` | 5-7 | Valid/invalid/revoked/expired PAT, scope extraction |
| `ScopeAuthorizationHandlerTests` | 4-6 | Scope matching, role-to-scope mapping, admin bypass |
| `AdminSeedServiceTests` | 3-4 | Create when missing, skip when exists, add role |

### Integration tests — update existing + new classes

**Update `WebApplicationFactory` setup** in all existing integration tests:
- Seed admin via env vars in `UseSetting()`
- Add `CreateAuthenticatedClientAsync()` helper to authenticate test `HttpClient`

**New integration test classes:**

| Test Class | Count | Coverage |
|-----------|-------|----------|
| `AuthenticationIntegrationTests` | 8-10 | Login, register, logout, cookie flow, PAT auth, JWT auth, invalid creds |
| `AuthorizationIntegrationTests` | 6-8 | Viewer can't write, Editor can, Admin settings access, 401 for unauth, 403 for wrong role |
| `PatIntegrationTests` | 5-6 | Create, list, revoke, use revoked → 401 |
| `RateLimitIntegrationTests` | 2-3 | Exceed limits → 429 |

---

## Phase 11: Deployment + Config

**Complexity: S** | **Dependencies: All phases** | **Session: G**

### docker-compose.yml changes
- Add env vars: `CONNAPSE_ADMIN_EMAIL`, `CONNAPSE_ADMIN_PASSWORD`, `CONNAPSE_JWT_SECRET`
- Add `appdata` volume for auto-generated JWT secret persistence

### appsettings.json additions
```json
"Identity": {
  "AllowRegistration": true,
  "Jwt": {
    "AccessTokenLifetimeMinutes": 60,
    "RefreshTokenLifetimeDays": 7,
    "Issuer": "Connapse",
    "Audience": "Connapse"
  },
  "RateLimiting": {
    "UploadsPerHour": 100,
    "SearchesPerHour": 1000
  }
}
```

### Breaking change notice
- All API endpoints now require authentication (previously open)
- CLI users must run `connapse auth login` to generate a PAT
- Document in release notes + SECURITY.md update

---

## File Inventory

### New files (~27)
- `src/Connapse.Identity/` — 15 files (csproj, DbContext, 5 entities, 2 auth handlers, 2 authorization, 4 services, 1 DI extension)
- `src/Connapse.Core/` — 2 files (IAuditLogger, AuthModels)
- `src/Connapse.Web/Endpoints/` — 1 file (AuthEndpoints)
- `src/Connapse.Web/Components/Pages/` — 6 files (Login, Register, Logout, PersonalTokens, Users, AccessDenied)
- `tests/Connapse.Identity.Tests/` — ~6 files (csproj + 5 test classes)

### Modified files (~17)
- `Connapse.slnx` — add 2 projects
- `src/Connapse.Web/Connapse.Web.csproj` — add Identity reference
- `src/Connapse.CLI/Connapse.CLI.csproj` — add Identity reference
- `src/Connapse.Web/Program.cs` — Identity services, auth middleware, rate limiting
- `src/Connapse.Web/Components/App.razor` — CascadingAuthenticationState
- `src/Connapse.Web/Components/Routes.razor` — AuthorizeRouteView
- `src/Connapse.Web/Components/_Imports.razor` — auth using statements
- `src/Connapse.Web/Components/Layout/NavMenu.razor` — auth-aware nav
- `src/Connapse.Web/Endpoints/*.cs` — 7 files: RequireAuthorization on all groups
- `src/Connapse.Web/Hubs/IngestionHub.cs` — [Authorize]
- `src/Connapse.CLI/Program.cs` — auth commands + PAT header
- `docker-compose.yml` — admin env vars, JWT secret
- `src/Connapse.Web/appsettings.json` — Identity config section
- Existing integration tests — add auth to test clients

---

## Key Risks

1. **Two DbContexts sharing one DB** — Use separate migration history tables. Configure via `MigrationsHistoryTable` option.
2. **Blazor login chicken-and-egg** — Login/register MUST be static SSR (form POST), not InteractiveServer which needs SignalR (which needs auth).
3. **Existing integration tests will break** — Update test infrastructure FIRST before adding RequireAuthorization to endpoints. Add `CreateAuthenticatedClientAsync()` helper.
4. **PAT lookup performance** — Index `token_hash` column. This is a hot path.
5. **JWT secret persistence** — Auto-generated secret must survive container restarts. Persist to data directory volume.

---

## Verification

1. **Build**: `dotnet build` — 0 errors across all 12 projects (10 existing + Identity + Identity.Tests)
2. **Unit tests**: `dotnet test --filter "Category=Unit"` — existing 171 + ~25 new Identity tests
3. **Integration tests**: `dotnet test --filter "Category=Integration"` — existing 40 (updated for auth) + ~22 new auth tests
4. **Manual testing**:
   - Start with `docker compose up`, verify admin user auto-created
   - Login via Blazor UI, verify cookie auth works
   - Create PAT via UI, use it to call REST API with `curl -H "X-Api-Key: cnp_..."`
   - Get JWT via `POST /api/v1/auth/token`, use it with `curl -H "Authorization: Bearer ..."`
   - Verify unauthenticated requests return 401
   - Verify wrong role returns 403
   - Verify rate limiting returns 429 after threshold
   - CLI: `connapse auth login`, then `connapse search "test" --container mycontainer`
